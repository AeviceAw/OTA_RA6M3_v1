/*Â© 2021 Aevice Health Pte Ltd. All rights reserved.*/
/*
 * mRollOff.c
 *
 *  Created on: 10 Jun 2022
 *      Author: YY
 */


#include "initialisations.h"

float rollOff(float* xn, float thres, int nfft, int fs);
void getRollOffFFT(float32_t *fin, float32_t *S_m);

/*
* Compute ratio of the Spectral roll Off, M_40 Features of KMDC
*
* Explanation:
*
* Magnitude
* Y(k), k = 1,...,10,...,NFFT/2,
*  ^
*  |   :
*  |  :  :
*  | :    :......................
*  |------------------------------> Bin Index
*          k=10               |
*  | sum(1:10)>thres|        NFFT/2 = 50
*
* mC = 10/nFFT * Fs, i.e., mC = ratio of k/nFFT, where sum(Y(1:k))>Thres
*
* Arguments : float* xn  pointer to input vector of the nth time domain window
*             float Threshold of rollOff
*             int  nFFT Bin
*             int Sampling Rate
*
* Return Float: Ratio of rollOff-Frequency/NumOfBins
*/
float rollOff(float* xn, float thres, int nfft, int fs){
    float mC=0.0f;
    int Kbins = (int) (((float)nfft)*0.5f);
    volatile float Y_sum =0.0f;
    volatile float Yk=0.0f;
#ifndef TEST_ROLLOFF
    float* Y = (float*) calloc((size_t)nfft,sizeof(float));
    //volatile float Y[512] ={0.0f};
    getRollOffFFT(xn, Y);
#endif
#ifdef TEST_ROLLOFF
    // FFT of First 512 samles of C001_WZ_001.wav from clinical trial (Dr. Sunit's Annotation)
    float Y[512] = {0.000001f,0.189905f,0.423399f,0.809626f,1.777512f,5.960295f,14.539060f,27.117657f,31.521507f,24.359955f,11.260429f,4.455096f,4.250508f,5.043841f,5.150145f,3.394786f,3.822479f,3.471316f,2.701713f,0.490920f,0.667892f,0.886031f,0.478446f,1.361283f,0.438818f,1.033773f,1.130480f,0.327018f,0.375109f,0.710368f,0.257832f,0.401030f,0.238227f,0.493001f,0.620818f,0.234359f,1.000127f,0.436439f,0.238838f,0.403948f,0.449742f,0.490746f,0.560070f,0.329637f,0.278799f,0.317112f,0.267228f,0.365044f,0.337035f,0.119050f,0.236331f,0.347307f,0.383776f,0.367632f,0.316663f,0.342475f,0.140938f,0.269356f,0.080023f,0.144995f,0.097283f,0.053786f,0.026673f,0.125115f,0.196431f,0.125013f,0.165322f,0.161469f,0.059628f,0.089869f,0.087267f,0.066284f,0.039799f,0.070234f,0.051585f,0.056500f,0.067195f,0.044943f,0.040704f,0.029914f,0.069835f,0.047823f,0.066813f,0.088306f,0.099892f,0.096558f,0.072209f,0.138676f,0.015676f,0.046405f,0.090256f,0.064984f,0.038488f,0.036881f,0.041911f,0.148136f,0.020897f,0.111959f,0.061060f,0.020167f,0.041248f,0.019297f,0.079360f,0.090314f,0.078414f,0.076006f,0.106054f,0.049976f,0.036720f,0.071376f,0.031373f,0.040199f,0.001817f,0.040848f,0.039072f,0.126853f,0.020219f,0.079784f,0.089288f,0.023304f,0.039853f,0.091965f,0.046370f,0.023965f,0.082328f,0.071127f,0.080983f,0.083598f,0.056379f,0.048182f,0.089294f,0.061727f,0.087304f,0.061134f,0.045618f,0.058684f,0.065634f,0.090677f,0.039965f,0.081300f,0.065431f,0.022484f,0.059145f,0.045746f,0.058437f,0.054130f,0.060479f,0.031610f,0.074766f,0.048061f,0.016103f,0.047320f,0.070982f,0.020958f,0.064273f,0.099176f,0.038366f,0.068189f,0.048584f,0.096894f,0.032519f,0.082003f,0.038227f,0.061954f,0.047966f,0.060791f,0.032458f,0.022593f,0.092754f,0.065108f,0.058692f,0.109691f,0.064953f,0.111270f,0.053652f,0.021174f,0.089989f,0.017337f,0.085243f,0.027486f,0.094768f,0.048560f,0.101404f,0.112080f,0.014329f,0.100178f,0.044508f,0.032237f,0.042676f,0.014079f,0.039597f,0.053119f,0.064628f,0.006811f,0.106372f,0.107325f,0.008749f,0.072780f,0.038907f,0.042014f,0.021972f,0.041968f,0.022463f,0.018060f,0.028158f,0.043626f,0.024896f,0.017327f,0.013968f,0.020693f,0.015298f,0.017889f,0.033511f,0.002081f,0.033672f,0.023394f,0.021542f,0.013712f,0.030585f,0.028173f,0.036967f,0.048260f,0.011251f,0.001442f,0.012429f,0.019941f,0.031239f,0.038652f,0.046751f,0.026507f,0.056384f,0.043570f,0.044658f,0.054999f,0.031411f,0.065636f,0.030347f,0.027894f,0.035661f,0.026230f,0.029301f,0.023076f,0.015860f,0.059060f,0.041203f,0.037543f,0.001785f,0.077801f,0.058773f,0.020273f,0.056001f,0.063905f,0.003921f,0.038597f,0.040056f,0.043076f,0.040962f,0.043076f,0.040056f,0.038597f,0.003921f,0.063905f,0.056001f,0.020273f,0.058773f,0.077801f,0.001785f,0.037543f,0.041203f,0.059060f,0.015860f,0.023076f,0.029301f,0.026230f,0.035661f,0.027894f,0.030347f,0.065636f,0.031411f,0.054999f,0.044658f,0.043570f,0.056384f,0.026507f,0.046751f,0.038652f,0.031239f,0.019941f,0.012429f,0.001442f,0.011251f,0.048260f,0.036967f,0.028173f,0.030585f,0.013712f,0.021542f,0.023394f,0.033672f,0.002081f,0.033511f,0.017889f,0.015298f,0.020693f,0.013968f,0.017327f,0.024896f,0.043626f,0.028158f,0.018060f,0.022463f,0.041968f,0.021972f,0.042014f,0.038907f,0.072780f,0.008749f,0.107325f,0.106372f,0.006811f,0.064628f,0.053119f,0.039597f,0.014079f,0.042676f,0.032237f,0.044508f,0.100178f,0.014329f,0.112080f,0.101404f,0.048560f,0.094768f,0.027486f,0.085243f,0.017337f,0.089989f,0.021174f,0.053652f,0.111270f,0.064953f,0.109691f,0.058692f,0.065108f,0.092754f,0.022593f,0.032458f,0.060791f,0.047966f,0.061954f,0.038227f,0.082003f,0.032519f,0.096894f,0.048584f,0.068189f,0.038366f,0.099176f,0.064273f,0.020958f,0.070982f,0.047320f,0.016103f,0.048061f,0.074766f,0.031610f,0.060479f,0.054130f,0.058437f,0.045746f,0.059145f,0.022484f,0.065431f,0.081300f,0.039965f,0.090677f,0.065634f,0.058684f,0.045618f,0.061134f,0.087304f,0.061727f,0.089294f,0.048182f,0.056379f,0.083598f,0.080983f,0.071127f,0.082328f,0.023965f,0.046370f,0.091965f,0.039853f,0.023304f,0.089288f,0.079784f,0.020219f,0.126853f,0.039072f,0.040848f,0.001817f,0.040199f,0.031373f,0.071376f,0.036720f,0.049976f,0.106054f,0.076006f,0.078414f,0.090314f,0.079360f,0.019297f,0.041248f,0.020167f,0.061060f,0.111959f,0.020897f,0.148136f,0.041911f,0.036881f,0.038488f,0.064984f,0.090256f,0.046405f,0.015676f,0.138676f,0.072209f,0.096558f,0.099892f,0.088306f,0.066813f,0.047823f,0.069835f,0.029914f,0.040704f,0.044943f,0.067195f,0.056500f,0.051585f,0.070234f,0.039799f,0.066284f,0.087267f,0.089869f,0.059628f,0.161469f,0.165322f,0.125013f,0.196431f,0.125115f,0.026673f,0.053786f,0.097283f,0.144995f,0.080023f,0.269356f,0.140938f,0.342475f,0.316663f,0.367632f,0.383776f,0.347307f,0.236331f,0.119050f,0.337035f,0.365044f,0.267228f,0.317112f,0.278799f,0.329637f,0.560070f,0.490746f,0.449742f,0.403948f,0.238838f,0.436439f,1.000127f,0.234359f,0.620818f,0.493001f,0.238227f,0.401030f,0.257832f,0.710368f,0.375109f,0.327018f,1.130480f,1.033773f,0.438818f,1.361283f,0.478446f,0.886031f,0.667892f,0.490920f,2.701713f,3.471316f,3.822479f,3.394786f,5.150145f,5.043841f,4.250508f,4.455096f,11.260429f,24.359955f,31.521507f,27.117657f,14.539060f,5.960295f,1.777512f,0.809626f,0.423399f,0.189905f};
#endif
    for (int kk=0;kk<Kbins;kk++)
        Y_sum=Y_sum +Y[kk];

    for (int kk=0;kk<Kbins;kk++){
        Yk = Yk + Y[kk];
        if (thres < Yk/Y_sum){
            mC = ((float)(kk))/((float)nfft) * ((float)fs);
            break;
        } // end if Sum > Thres
    }// end for kk=1:K
#ifndef TEST_ROLLOFF
    free(Y);
#endif
    return mC;
} // end rollOff()

void getRollOffFFT(float32_t *fin, float32_t *S_m)
{
	int winL = 512;

    volatile float32_t fout[1024] ={0.0f};
    //volatile float* fout = (float*)calloc((size_t)(winL+winL),sizeof(float));

    /* (1) Prepare the Vector to perform fft */
    for (uint32_t i1 = 0, i2 = 0, i3 = 0; i1 < (uint32_t)winL; i1++)
    {
        fout[i2] = fin[i1];
        i2++;
        i3++;
        fout[i2] = 0.0f;
        i2++;
    } // end for ( i1 = 1:nwind + offset ; i2 = 0, i3 = 1:nwind )

    /* (2) process the data through the CFFT/CIFFT module */
    //int8_T WZifftFlag = 0 (forward transform);  int8_T WZdoBitReverse = 1 (enables bit reversal of output);
    switch (winL){
    case 256:
    	arm_cfft_f32(&arm_cfft_sR_f32_len32,  (float32_t*)fout, 0, 1);
    	break;
    case 512:
    	arm_cfft_f32(&arm_cfft_sR_f32_len512, (float32_t*)fout, 0, 1);
    	break;
    case 1024:
    	arm_cfft_f32(&arm_cfft_sR_f32_len1024, (float32_t*)fout, 0, 1);
    	break;
    case 2048:
    	arm_cfft_f32(&arm_cfft_sR_f32_len2048, (float32_t*)fout, 0, 1);
    	break;
    case 4096:
    	arm_cfft_f32(&arm_cfft_sR_f32_len4096, (float32_t*)fout, 0, 1);
    	break;
    }

    // (2) clear Mag for the mth-window FFT
    //for (uint32_t ii = 0; ii < (uint32_t) winL ; ii ++)
        //S_m[ii] = 0.0f;
    memset(S_m,0,(size_t) sizeof(float32_t)*((uint32_t)winL));

    /* (3) Process the data through the Complex Magnitude Module for
            calculating the magnitude at each bin */
    arm_cmplx_mag_f32((float32_t*)fout, S_m, (uint32_t)winL);

    //free(fout);
} // getRollOffFFT()
